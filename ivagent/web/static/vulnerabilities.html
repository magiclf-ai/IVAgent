<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>漏洞管理 - IVAgent</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=ZCOOL+KuaiLe&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="/static/bootstrap.min.css" rel="stylesheet">
    <link href="/static/bootstrap-icons.min.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
    <link href="/static/highlight-github.min.css" rel="stylesheet">
    <script src="/static/highlight.min.js"></script>
    <script src="/static/chart.umd.min.js"></script>
</head>
<body>

    <div class="d-flex" id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <div class="sidebar-heading">
                <i class="bi bi-robot text-primary"></i> IVAgent
                <small class="ms-2" style="font-size: 0.8rem; opacity: 0.7;">v1.0</small>
            </div>
            <div class="list-group list-group-flush my-3">
                <a href="/#dashboard" class="list-group-item list-group-item-action nav-item">
                    <i class="bi bi-speedometer2"></i> 仪表盘
                </a>
                <a href="/#logs" class="list-group-item list-group-item-action nav-item">
                    <i class="bi bi-list-ul"></i> 日志列表
                </a>
                <a href="/#agents" class="list-group-item list-group-item-action nav-item">
                    <i class="bi bi-diagram-3"></i> Agent 时间轴
                </a>
                <a href="/#toolcalls" class="list-group-item list-group-item-action nav-item">
                    <i class="bi bi-tools"></i> Tool Call 日志
                </a>
                <div class="sidebar-heading mt-4" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.1em; color: rgba(255,255,255,0.4); border-bottom: none; padding-bottom: 0;">
                    系统管理
                </div>
                <a href="/vulnerabilities" class="list-group-item list-group-item-action nav-item active">
                    <i class="bi bi-shield-exclamation"></i> 漏洞管理
                </a>
                <a href="/redis" class="list-group-item list-group-item-action nav-item">
                    <i class="bi bi-database"></i> Redis 缓存
                </a>
            </div>
            
            <div class="sidebar-footer">
                <div class="d-flex align-items-center justify-content-between">
                    <span id="ws-text" class="small" style="opacity: 0.7">离线</span>
                    <span id="ws-status" class="status-dot offline"></span>
                </div>
            </div>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <nav class="navbar navbar-expand-lg border-bottom mb-4">
                <div class="container-fluid">
                    <button class="btn btn-light btn-sm border" id="menu-toggle"><i class="bi bi-list"></i></button>
                    <span class="navbar-brand ms-3 text-primary fw-bold">漏洞管理中心</span>
                </div>
            </nav>

            <div class="container-fluid px-4">
                <!-- Stats Row -->
                <div class="row g-4 mb-4">
                    <div class="col-md-2 col-sm-6">
                        <div class="card stat-card severity-critical h-100 p-3">
                            <div class="stat-icon"><i class="bi bi-exclamation-octagon-fill"></i></div>
                            <div class="stat-details">
                                <h3 id="stat-critical">0</h3>
                                <p>严重漏洞</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <div class="card stat-card severity-high h-100 p-3">
                            <div class="stat-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
                            <div class="stat-details">
                                <h3 id="stat-high">0</h3>
                                <p>高危漏洞</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <div class="card stat-card severity-medium h-100 p-3">
                            <div class="stat-icon"><i class="bi bi-exclamation-circle-fill"></i></div>
                            <div class="stat-details">
                                <h3 id="stat-medium">0</h3>
                                <p>中危漏洞</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2 col-sm-6">
                        <div class="card stat-card severity-low h-100 p-3">
                            <div class="stat-icon"><i class="bi bi-info-circle-fill"></i></div>
                            <div class="stat-details">
                                <h3 id="stat-low">0</h3>
                                <p>低危漏洞</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-sm-12">
                        <div class="card stat-card total h-100 p-3">
                            <div class="stat-icon"><i class="bi bi-shield-check"></i></div>
                            <div class="stat-details">
                                <h3 id="stat-total">0</h3>
                                <p>总漏洞数</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title text-primary mb-3">严重程度分布</h5>
                                <div style="height: 200px;">
                                    <canvas id="severity-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title text-primary mb-3">发现趋势</h5>
                                <div style="height: 200px;">
                                    <canvas id="trend-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Toolbar -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-body p-3">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-2">
                                <label class="form-label text-muted small text-uppercase fw-bold">严重程度</label>
                                <select class="form-select form-select-sm" id="filter-severity">
                                    <option value="">全部</option>
                                    <option value="critical">严重</option>
                                    <option value="high">高危</option>
                                    <option value="medium">中危</option>
                                    <option value="low">低危</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label text-muted small text-uppercase fw-bold">状态</label>
                                <select class="form-select form-select-sm" id="filter-status">
                                    <option value="">全部</option>
                                    <option value="new">新发现</option>
                                    <option value="confirmed">已确认</option>
                                    <option value="fixed">已修复</option>
                                    <option value="false_positive">误报</option>
                                    <option value="ignored">已忽略</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label text-muted small text-uppercase fw-bold">漏洞类型</label>
                                <select class="form-select form-select-sm" id="filter-type">
                                    <option value="">全部</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label text-muted small text-uppercase fw-bold">搜索</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text bg-white border-end-0 text-secondary"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control border-start-0" id="search-input" placeholder="搜索漏洞名称、函数或路径...">
                                </div>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-primary btn-sm w-100" onclick="vulnList.refresh()">
                                    <i class="bi bi-arrow-clockwise me-1"></i> 刷新列表
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- List -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-transparent border-bottom d-flex justify-content-between align-items-center py-3">
                        <h6 class="mb-0 text-primary fw-bold"><i class="bi bi-list-task me-2"></i>漏洞列表</h6>
                        <span class="badge bg-light text-secondary border" id="vuln-count">共 0 个漏洞</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="vuln-list" class="list-group list-group-flush">
                            <!-- JS will populate this -->
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-top py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small" id="page-info">1 / 1</span>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" id="prev-page" disabled><i class="bi bi-chevron-left"></i> 上一页</button>
                                <button class="btn btn-outline-secondary" id="next-page" disabled>下一页 <i class="bi bi-chevron-right"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal fade" id="vuln-modal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="d-flex align-items-center gap-3">
                        <span id="modal-severity" class="severity-badge"></span>
                        <h5 class="modal-title mb-0 fw-bold" id="modal-title">漏洞详情</h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="vuln-detail-grid">
                        <!-- Left Column: Details -->
                        <div class="left-col">
                            <div class="detail-section">
                                <h3><i class="bi bi-card-text me-2"></i>漏洞描述</h3>
                                <p id="modal-description" class="text-body mb-0"></p>
                            </div>

                            <div class="detail-section">
                                <h3><i class="bi bi-signpost-split me-2"></i>调用路径</h3>
                                <div id="modal-call-path" class="small font-monospace" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>

                            <div class="detail-section">
                                <h3><i class="bi bi-diagram-3 me-2"></i>数据流分析</h3>
                                <div id="modal-data-flow"></div>
                            </div>

                            <div class="detail-section">
                                <h3><i class="bi bi-list-nested me-2"></i>调用栈</h3>
                                <div id="modal-call-stack" class="small text-secondary font-monospace" style="max-height: 150px; overflow-y: auto;"></div>
                            </div>

                            <div class="detail-section">
                                <h3><i class="bi bi-search me-2"></i>证据</h3>
                                <ul id="modal-evidence" class="ps-3 mb-0 small text-secondary"></ul>
                            </div>

                            <div class="detail-section" id="code-section">
                                <h3><i class="bi bi-code-square me-2"></i>相关代码</h3>
                                <div class="code-block">
                                    <pre><code class="language-python" id="modal-code"></code></pre>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h3><i class="bi bi-tools me-2"></i>修复建议</h3>
                                <div class="remediation-box" id="modal-remediation"></div>
                            </div>
                        </div>

                        <!-- Right Column: Meta Info -->
                        <div class="right-col">
                            <div class="detail-section">
                                <h3><i class="bi bi-info-circle me-2"></i>基本信息</h3>
                                <div class="info-item">
                                    <span class="info-label">漏洞类型</span>
                                    <span class="info-value" id="modal-type"></span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">置信度</span>
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="progress" style="width: 60px; height: 6px;">
                                            <div class="progress-bar bg-primary" id="modal-confidence" role="progressbar"></div>
                                        </div>
                                        <span class="info-value" id="modal-confidence-text"></span>
                                    </div>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">发现时间</span>
                                    <span class="info-value" id="modal-time"></span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Agent ID</span>
                                    <span class="info-value font-monospace" id="modal-agent"></span>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h3><i class="bi bi-geo-alt me-2"></i>位置信息</h3>
                                <div class="info-item">
                                    <span class="info-label">函数</span>
                                    <span class="info-value font-monospace text-truncate" style="max-width: 150px;" id="modal-function"></span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">位置</span>
                                    <span class="info-value font-monospace" id="modal-location"></span>
                                </div>
                                <div class="mb-2 mt-2">
                                    <span class="info-label d-block mb-1">文件路径</span>
                                    <div class="bg-light p-2 rounded small text-break font-monospace" id="modal-file"></div>
                                </div>
                            </div>

                            <div class="detail-section">
                                <h3><i class="bi bi-check-circle me-2"></i>状态管理</h3>
                                <select class="form-select form-select-sm mb-2" id="modal-status-select">
                                    <option value="new">新发现</option>
                                    <option value="confirmed">已确认</option>
                                    <option value="fixed">已修复</option>
                                    <option value="false_positive">误报</option>
                                    <option value="ignored">已忽略</option>
                                </select>
                                <button class="btn btn-primary btn-sm w-100" onclick="vulnDetail.saveStatus()">
                                    更新状态
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

    <script src="/static/bootstrap.bundle.min.js"></script>
    <script src="/static/vulnerabilities.js"></script>
</body>
</html>