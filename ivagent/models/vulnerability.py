#!/usr/bin/env python3
"""
漏洞数据模型

定义漏洞、污点源、数据流路径等核心数据结构
"""

from typing import List, Dict, Optional, Any
from dataclasses import dataclass, field
from enum import Enum


class VulnerabilityType(Enum):
    """漏洞类型枚举"""
    BUFFER_OVERFLOW = "缓冲区溢出"
    ARRAY_OOB = "数组越界"
    ARBITRARY_RW = "任意地址读写"
    FORMAT_STRING = "格式化字符串"
    INTEGER_OVERFLOW = "整数溢出"
    USE_AFTER_FREE = "UAF (释放后使用)"
    DOUBLE_FREE = "双重释放"
    NULL_POINTER = "空指针解引用"
    UNINITIALIZED = "未初始化变量"
    COMMAND_INJECTION = "命令注入"
    SQL_INJECTION = "SQL注入"
    PATH_TRAVERSAL = "路径遍历"
    UNKNOWN = "未知类型"


@dataclass
class TaintSource:
    """
    污点源
    
    描述攻击者可控制的数据来源
    """
    name: str                           # 变量/参数名
    source_type: str                    # 来源类型
    # 例如: "user_input", "network", "file", "env", "argument"
    
    description: str = ""               # 描述
    location: str = ""                  # 位置信息
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "name": self.name,
            "source_type": self.source_type,
            "description": self.description,
            "location": self.location,
        }


@dataclass
class DataFlowPath:
    """
    数据流路径
    
    描述污点数据从源到漏洞点的传播路径
    """
    source: str                         # 污点源
    intermediate_nodes: List[str] = field(default_factory=list)  # 中间节点
    sink: str = ""                      # 漏洞点
    path_description: str = ""          # 路径描述
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "source": self.source,
            "intermediate_nodes": self.intermediate_nodes,
            "sink": self.sink,
            "path_description": self.path_description,
        }


@dataclass
class Vulnerability:
    """
    漏洞模型
    
    完整的漏洞描述，包括类型、位置、数据流、修复建议等
    """
    type: VulnerabilityType              # 漏洞类型
    name: str                            # 漏洞名称
    description: str                     # 详细描述
    location: str                        # 位置信息
    
    severity: float = 0.5                # 严重程度 (0-1)
    confidence: float = 0.5              # 置信度 (0-1)
    
    data_flow: Optional[DataFlowPath] = None  # 数据流路径
    
    # 触发条件
    trigger_conditions: List[str] = field(default_factory=list)
    
    # 影响范围
    impact_scope: str = ""
    
    # 修复建议
    remediation: str = ""
    
    # 元数据
    metadata: Dict[str, Any] = field(default_factory=dict)
    
    def to_dict(self) -> Dict[str, Any]:
        return {
            "type": self.type.value,
            "name": self.name,
            "description": self.description,
            "location": self.location,
            "severity": self.severity,
            "confidence": self.confidence,
            "data_flow": self.data_flow.to_dict() if self.data_flow else None,
            "trigger_conditions": self.trigger_conditions,
            "impact_scope": self.impact_scope,
            "remediation": self.remediation,
            "metadata": self.metadata,
        }
    
    def is_high_confidence(self) -> bool:
        """是否高置信度"""
        return self.confidence >= 0.8
    
    def is_high_severity(self) -> bool:
        """是否高严重程度"""
        return self.severity >= 0.7
    
    def get_risk_score(self) -> float:
        """获取风险评分 (severity * confidence)"""
        return self.severity * self.confidence
