# IVAgent 架构设计文档

## 1. 系统概述

### 1.1 设计目标

IVAgent 是一个面向安全研究的智能程序分析框架，旨在通过大语言模型 (LLM) 增强传统静态分析能力，实现：

1. **深度漏洞挖掘**：超越传统规则匹配的语义级漏洞检测
2. **跨平台支持**：统一接口支持多种反编译器和源码分析
3. **高并发分析**：异步架构支持大规模批量分析
4. **可解释性**：完整的分析过程追溯和可视化

### 1.2 核心设计原则

- **异步优先**：所有 IO 操作采用异步设计，最大化并发性能
- **分层架构**：清晰的层间边界，便于扩展和维护
- **插件化引擎**：支持多种后端分析工具的即插即用
- **配置驱动**：通过前置条件配置降低 LLM 使用门槛

## 2. 系统架构

### 2.1 总体架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              IVAgent 系统架构                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          接入层 (Access Layer)                       │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │  CLI 工具    │  │  Web 服务    │  │  Python API  │              │   │
│  │  │ ivagent_scan │  │  日志可视化  │  │  import      │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  └────────────────────────────────┬────────────────────────────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          应用层 (Application)                        │   │
│  │  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────────┐   │   │
│  │  │  IVAgentScanner  │  │  LogManager      │  │  VulnManager     │   │   │
│  │  │  统一扫描接口    │  │  日志管理        │  │  漏洞管理        │   │   │
│  │  └──────────────────┘  └──────────────────┘  └──────────────────┘   │   │
│  └────────────────────────────────┬────────────────────────────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          智能体层 (Agent Layer)                      │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                      BaseAgent (抽象基类)                    │   │   │
│  │  │  - 异步状态管理  - 执行历史记录  - 并发控制  - LLM 交互封装   │   │   │
│  │  └───────────────────────────┬─────────────────────────────────┘   │   │
│  │                              │                                      │   │
│  │        ┌─────────────────────┼─────────────────────┐                │   │
│  │        ▼                     ▼                     ▼                │   │
│  │  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐          │   │
│  │  │DeepVulnAgent │    │CallsiteAgent │    │FuncSummary   │          │   │
│  │  │深度漏洞挖掘  │    │调用点分析    │    │函数摘要      │          │   │
│  │  └──────────────┘    └──────────────┘    └──────────────┘          │   │
│  │                                                                     │   │
│  └────────────────────────────────┬────────────────────────────────────┘   │
│                                   │                                         │
│                                   ▼                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          引擎层 (Engine Layer)                       │   │
│  │                                                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │              BaseStaticAnalysisEngine (抽象基类)             │   │   │
│  │  │  - 函数定义获取  - 调用关系分析  - 交叉引用查询  - 变量约束    │   │   │
│  │  └───────────────────────────┬─────────────────────────────────┘   │   │
│  │                              │                                      │   │
│  │  ┌──────────────┬──────────────┬──────────────┬──────────────┐     │   │
│  │  ▼              ▼              ▼              ▼              ▼     │   │
│  │ ┌─────┐     ┌─────┐     ┌─────────┐     ┌─────────┐             │   │
│  │ │ IDA │     │ JEB │     │  ABC    │     │ Source  │             │   │
│  │ │     │     │     │     │         │     │         │             │   │
│  │ │PE/  │     │APK/ │     │HarmonyOS│     │通用源码 │             │   │
│  │ │ELF  │     │DEX  │     │  ABC    │     │ 分析    │             │   │
│  │ └─────┘     └─────┘     └─────────┘     └─────────┘             │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          数据层 (Data Layer)                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │ 漏洞模型     │  │ 约束模型     │  │ 调用点模型   │              │   │
│  │  │ Vulnerability│  │ Precondition │  │ CallsiteInfo │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          基础设施层 (Infrastructure)                 │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │   │
│  │  │ LLM Client   │  │ 日志存储     │  │ 缓存系统     │              │   │
│  │  │ Tool Call    │  │ SQLite/JSON  │  │ Memory/Disk  │              │   │
│  │  └──────────────┘  └──────────────┘  └──────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 模块职责

| 层级 | 模块 | 职责 |
|------|------|------|
| 接入层 | CLI | 命令行接口，支持批量扫描和配置管理 |
| 接入层 | Web | 可视化界面，实时展示分析过程和结果 |
| 应用层 | Scanner | 统一的扫描入口，协调引擎和 Agent |
| 智能体层 | DeepVulnAgent | 核心漏洞挖掘逻辑，Tool Call 驱动 |
| 智能体层 | CallsiteAgent | 解析函数调用点，支持跨函数分析 |
| 引擎层 | IDA Engine | IDA Pro 接口，分析二进制文件 |
| 引擎层 | JEB Engine | JEB 接口，分析 Android 应用 |
| 引擎层 | ABC Engine | ABC Decompiler 接口，分析鸿蒙应用 |
| 引擎层 | Source Engine | 源码分析引擎，基于文本搜索 |

## 3. 核心组件详解

### 3.1 Agent 层设计

#### 3.1.1 BaseAgent 基类

```python
class BaseAgent(ABC):
    """
    Agent 抽象基类，提供通用功能：
    - 异步状态管理（线程安全）
    - 执行历史记录
    - 并发控制（信号量）
    - LLM 交互封装
    - 工具调用管理
    """
```

核心能力：
- **异步安全**：使用 `asyncio.Lock` 保护共享状态
- **并发控制**：通过信号量限制同时进行的 LLM 调用
- **执行追溯**：完整记录每一步操作和结果
- **工具抽象**：统一的工具描述、调用和解析接口

#### 3.1.2 DeepVulnAgent 工作流

```
┌─────────────────────────────────────────────────────────────────┐
│                    DeepVulnAgent 工作流程                        │
└─────────────────────────────────────────────────────────────────┘

  ┌─────────────┐
  │   Start     │
  └──────┬──────┘
         ▼
  ┌─────────────────┐
  │ 1. 获取函数定义  │ ◄── 调用 Engine.get_function_def()
  │    (伪代码/源码) │
  └────────┬────────┘
           ▼
  ┌─────────────────┐
  │ 2. LLM 初始分析  │ ◄── System Prompt + Function Code
  │    (第一次调用)  │
  └────────┬────────┘
           ▼
  ┌──────────────────────────────────────────┐
  │ 3. 处理 Tool Calls                        │
  │    - get_function_summary: 获取子函数摘要 │
  │    - create_sub_agent: 创建子 Agent       │
  └────────┬─────────────────────────────────┘
           ▼
  ┌─────────────────┐
  │ 4. 并发执行 Tools│ ◄── asyncio.gather()
  └────────┬────────┘
           ▼
  ┌─────────────────┐
  │ 5. LLM 综合分析  │ ◄── 基于 Tool Results
  │    (第二次调用)  │
  └────────┬────────┘
           ▼
  ┌─────────────────┐
  │ 6. 输出漏洞结果  │
  │    (结构化 JSON) │
  └────────┬────────┘
           ▼
  ┌──────────────────────────────────────────┐
  │ 7. 递归分析 (可选)                        │
  │    - 对关键子函数创建子 Agent             │
  │    - 传播约束条件                         │
  └────────┬─────────────────────────────────┘
           ▼
  ┌─────────────┐
  │    End      │
  └─────────────┘
```

### 3.2 Engine 层设计

#### 3.2.1 抽象接口

```python
class BaseStaticAnalysisEngine(ABC):
    """
    所有分析引擎必须实现的接口：
    """
    
    # 核心查询
    async def get_function_def(self, ...) -> Optional[FunctionDef]
    async def get_callee(self, signature: str) -> List[CallSite]
    async def get_caller(self, signature: str) -> List[CallSite]
    
    # 高级分析
    async def get_cross_reference(self, ...) -> Optional[CrossReference]
    async def get_variable_constraints(self, ...) -> List[VariableConstraint]
    
    # 批量操作
    async def batch_get_function_defs(self, signatures: List[str]) -> Dict[str, FunctionDef]
```

#### 3.2.2 引擎工厂模式

```python
# 统一入口
def create_engine(
    engine_type: str,      # "ida", "jeb", "abc", "source"
    target_path: str,      # 分析目标路径
    **kwargs
) -> BaseStaticAnalysisEngine:
    # 根据类型创建对应引擎实例
```

### 3.3 数据模型设计

#### 3.3.1 核心模型关系

```
┌─────────────────────────────────────────────────────────────────┐
│                        数据模型关系                              │
└─────────────────────────────────────────────────────────────────┘

  ┌─────────────────┐
  │  Vulnerability  │
  │  漏洞           │
  ├─────────────────┤
  │ - type          │
  │ - name          │
  │ - description   │
  │ - severity      │
  │ - confidence    │
  │ - data_flow     │────┐
  │ - remediation   │    │
  └─────────────────┘    │
                         │
                         ▼
              ┌─────────────────┐
              │  DataFlowPath   │
              │  数据流路径     │
              ├─────────────────┤
              │ - source        │
              │ - sink          │
              │ - intermediate  │
              └─────────────────┘

  ┌─────────────────┐
  │  Precondition   │
  │  前置条件       │
  ├─────────────────┤
  │ - name          │
  │ - description   │
  │ - text_content  │◄─── Markdown 格式
  │ - taint_sources │
  └─────────────────┘

  ┌─────────────────┐
  │ FunctionContext │
  │ 函数分析上下文  │
  ├─────────────────┤
  │ - call_stack    │◄─── 调用链追踪
  │ - constraints   │◄─── 约束传播
  │ - taint_sources │
  │ - depth         │◄─── 递归深度控制
  └─────────────────┘
```

### 3.4 约束传播机制

#### 3.4.1 设计目标

- **降低 LLM 负担**：用结构化约束替代复杂的提示词工程
- **跨函数传播**：在调用链中传递参数约束
- **防止误报**：通过前置条件明确参数假设

#### 3.4.2 传播流程

```
Function A
  │ analyze()
  │
  ├──► Check precondition
  │      └── Get taint_sources, constraints
  │
  ├──► Analyze code
  │      └── Find call to Function B at line 10
  │            - arg1: ptr (with constraint "ptr != NULL")
  │            - arg2: size (with constraint "0 < size <= 1024")
  │
  └──► Create Sub-Agent for Function B
         └── Pass constraints: ["参数1 ptr: 已通过 ptr != NULL 检查",
                                 "参数2 size: 0 < size <= 1024"]

         Function B (Sub-Agent)
           │ analyze()
           │
           ├──► Receive parent constraints
           │      └── Use as context for analysis
           │
           ├──► Analyze with constraints applied
           │      └── Better precision in vulnerability detection
           │
           └──► Return results to parent
```

## 4. 并发设计

### 4.1 并发模型

```
┌─────────────────────────────────────────────────────────────────┐
│                      并发架构                                    │
└─────────────────────────────────────────────────────────────────┘

  Main Thread (Event Loop)
  │
  ├──► Semaphore (max_concurrency=10)
  │    │
  │    ├──► Task 1 ─────► LLM Call ─────► Result
  │    │
  │    ├──► Task 2 ─────► LLM Call ─────► Result
  │    │
  │    ├──► Task 3 ─────► Engine Query ─► Result
  │    │
  │    └──► Task N ...
  │
  └──► asyncio.gather() 等待所有任务完成
```

### 4.2 关键并发控制点

1. **Agent 级别**：`BaseAgent._semaphore` 控制 LLM 调用并发
2. **Engine 级别**：`BaseStaticAnalysisEngine._semaphore` 控制引擎查询并发
3. **批量操作**：`batch_get_function_defs()` 使用独立信号量

## 5. 日志与可观测性

### 5.1 日志架构

```
┌─────────────────────────────────────────────────────────────────┐
│                      日志系统架构                                │
└─────────────────────────────────────────────────────────────────┘

  Agent/Engine                    LogManager                    Storage
  ─────────────────────────────────────────────────────────────────
       │                              │                           │
       │ log_event()                  │                           │
       ├─────────────────────────────►│                           │
       │                              │ write()                   │
       │                              ├──────────────────────────►│
       │                              │                           │
       │                              │      SQLite / JSON        │
       │                              │                           │
       │                              ◄───────────────────────────┤
       │                              │                           │
       │                              │      ┌──────────────┐     │
       │                              │      │   Web UI     │     │
       │                              │      │  Real-time   │◄────┘
       │                              │      │  Display     │
       │                              │      └──────────────┘
       │                              │
       │ query()                      │
       ├─────────────────────────────►│
       │◄─────────────────────────────┤
```

### 5.2 日志类型

| 类型 | 内容 | 用途 |
|------|------|------|
| LLMLogEntry | Prompt, Response, Latency | 分析 LLM 交互质量 |
| AgentExecutionLog | Agent 调用链、执行时间 | 追踪分析过程 |
| AgentTaskLog | 任务状态、进度 | 监控批量分析 |
| VulnerabilityRecord | 漏洞详情、验证状态 | 漏洞管理 |

## 6. 扩展性设计

### 6.1 添加新引擎

```python
# 1. 继承基类
class MyEngine(BaseStaticAnalysisEngine):
    async def _do_initialize(self):
        # 初始化连接
        pass
    
    async def get_function_def(self, function_signature, **kwargs):
        # 实现获取函数定义
        pass
    
    # 实现其他抽象方法...

# 2. 注册到工厂
def create_engine(engine_type, ...):
    if engine_type == "my_engine":
        return MyEngine(...)
```

### 6.2 添加新 Agent

```python
# 1. 继承基类
class MyAgent(BaseAgent):
    async def run(self, **kwargs) -> Dict[str, Any]:
        # 实现分析逻辑
        # 使用 self.call_llm() 进行 LLM 交互
        # 使用 self.engine 获取代码信息
        pass

# 2. 导出到 __init__.py
__all__ = [..., "MyAgent"]
```

## 7. 安全考虑

### 7.1 输入验证

- 所有外部输入（函数签名、配置）均经过验证和清理
- Markdown 前置条件配置限制只读操作

### 7.2 资源限制

- 递归深度限制（防止无限递归）
- 并发数限制（防止资源耗尽）
- 超时控制（防止长时间挂起）

### 7.3 数据隔离

- 每个分析会话独立的日志存储
- Agent 执行状态相互隔离

## 8. 性能优化

### 8.1 缓存策略

```python
# 函数定义缓存
@lru_cache(maxsize=1000)
async def get_function_def_cached(signature: str) -> FunctionDef:
    return await engine.get_function_def(signature)

# LLM 响应缓存（基于 Prompt 哈希）
cache_key = hash(prompt + model + temperature)
```

### 8.2 批量操作

优先使用批量接口减少 RPC 往返：

```python
# 低效：逐个获取
for sig in signatures:
    func = await engine.get_function_def(sig)  # N 次 RPC

# 高效：批量获取
funcs = await engine.batch_get_function_defs(signatures)  # 1 次 RPC
```

## 9. 部署架构

### 9.1 单机部署

```
┌─────────────────────────────────────────┐
│              单机部署                    │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────┐    ┌─────────┐    ┌─────┐ │
│  │IVAgent  │◄──►│ IDA/JEB │◄──►│ IDB │ │
│  │Scanner  │    │  (RPC)  │    │/APK │ │
│  └────┬────┘    └─────────┘    └─────┘ │
│       │                                 │
│       ▼                                 │
│  ┌─────────┐    ┌─────────┐            │
│  │ Web Log │◄──►│ Browser │            │
│  │ Server  │    │         │            │
│  └─────────┘    └─────────┘            │
│                                         │
└─────────────────────────────────────────┘
```

### 9.2 分布式部署（未来）

```
┌─────────────────────────────────────────────────────────────┐
│                      分布式部署                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐         ┌─────────────────────────────┐   │
│  │   Client    │────────►│      IVAgent Controller     │   │
│  │   (CLI)     │         │       (任务调度)             │   │
│  └─────────────┘         └─────────────┬───────────────┘   │
│                                        │                   │
│                     ┌──────────────────┼──────────────────┐│
│                     │                  │                  ││
│                     ▼                  ▼                  ▼│
│              ┌─────────────┐   ┌─────────────┐   ┌────────┐│
│              │Worker Node 1│   │Worker Node 2│   │ Node N ││
│              │ IDA Engine  │   │ JEB Engine  │   │  ...   ││
│              └─────────────┘   └─────────────┘   └────────┘│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 10. 未来演进

### 10.1 计划功能

1. **Joern 引擎**：基于 CPG 的源码分析
2. **Tree-sitter 引擎**：轻量级源码分析
3. **分布式调度**：支持大规模并行分析
4. **模型微调**：基于分析结果持续优化
5. **CI/CD 集成**：GitHub Action / GitLab CI 插件

### 10.2 架构演进方向

- 向微服务架构演进
- 引入消息队列解耦组件
- 支持模型服务化部署
